<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quarter</title>

<!-- 引入 Akaya Kanadaka font-->
<link href="https://fonts.googleapis.com/css2?family=Akaya+Kanadaka&display=swap" rel="stylesheet">

<!-- 導入外部 CSS -->
<link rel="stylesheet" href="./styles/index.css">
</head>
    
<body>
<header>
    <img src="./images/quarter.png" alt="Logo" class="logo">
    <p class="slogan">give me a quarter; give you a circle</p>
    <h1>Quarter</h1>
</header>

<nav class="top-menu">
    <a href="./index.html">Home</a>
    <a href="#">About</a>
</nav>

<div class="container">
    <div class="side-bar" id="sideBar">
        <div class="sidebar-top">
            <div class="sidebar-title">Topics</div>
            <ul class="tree" id="treeMenu"></ul>
        </div>
        <div class="sidebar-bottom">
            <div class="sidebar-title">Units</div>
            <ul class="item-list" id="bottomList"></ul>
        </div>
    </div>

    <div class="toggle-button" id="toggleBtn">❮</div>

    <iframe id="pdfFrame" class="viewer" src="main.pdf" name="pdfFrame"
        allow="autoplay; encrypted-media; fullscreen">
    </iframe>
</div>

<footer>
    <span>version: 1.0.0</span>
    <span>
        <img src="https://hits.sh/powwhuang.github.io/quarter.svg?style=flat-square&label=Visitors&color=007ec6" alt="Visitor Count">
    </span>
</footer>

<!-- 先載入 menuData.js，再載入 index.js -->
<script src="./unit_data.js"></script>

<script>
// === DOM ===
const treeMenu=document.getElementById('treeMenu');
const bottomList=document.getElementById('bottomList');
const viewer=document.getElementById('pdfFrame');
const sideBar=document.getElementById('sideBar');
const toggleBtn=document.getElementById('toggleBtn');

// === 遞迴生成樹狀選單 ===
function buildTree(data,parent){
    for(const key in data){
        if(key==="units") continue;
        const val=data[key];
        const li=document.createElement('li');

        if(typeof val==="object" && !val.link){
            li.classList.add('folder');
            li.textContent=key;
            const ul=document.createElement('ul');
            buildTree(val,ul);
            li.appendChild(ul);
        }else{
            const a=document.createElement('a');
            a.textContent=key;
            a.href=val.link;
            a.target="pdfFrame";
            li.appendChild(a);
        }
        parent.appendChild(li);
    }
}
buildTree(unit_data,treeMenu);

// === 公用：移除所有 active ===
function removeActive(){
    document.querySelectorAll('.tree li a, .item-list li a, .tree li.folder')
        .forEach(el=>el.classList.remove('active'));
}

// === 更新 Quick Links ===
function updateQuickLinks(key,data){
    bottomList.innerHTML="";
    const items=(data[key] && data[key].units) || [];
    items.forEach(it=>{
        const li=document.createElement('li');
        const a=document.createElement('a');
        a.textContent=it.name;
        a.href=it.href;
        a.target="pdfFrame"; 
        li.appendChild(a);
        bottomList.appendChild(li);
    });
}

// === Folder 點擊 (展開/收合 + Quick Links) ===
treeMenu.addEventListener('click',e=>{
    const target=e.target;
    if(target.tagName.toLowerCase()==="li" && target.classList.contains('folder')){
        target.classList.toggle('open');
        removeActive();
        target.classList.add('active');
        const key=target.firstChild.textContent.trim();
        updateQuickLinks(key,unit_data);
    }
});

// === 子節點 (a) 點擊 (高亮 + Quick Links) ===
treeMenu.addEventListener('click',e=>{
    if(e.target.tagName.toLowerCase()==="a"){
        removeActive();
        e.target.classList.add('active');
        let parent=e.target.closest('li.folder');
        while(parent){
            parent.classList.add('active');
            parent=parent.parentElement.closest('li.folder');
        }
        const key=e.target.textContent.trim();
        for(const top in unit_data){
            if(unit_data[top][key]){
                updateQuickLinks(key,unit_data[top]);
                break;
            }
        }
    }
});

// Quick Links 點擊高亮
bottomList.addEventListener('click',e=>{
    if(e.target.tagName.toLowerCase()==="a"){
        removeActive();
        e.target.classList.add('active');
    }
});

// Toggle 側邊欄
toggleBtn.addEventListener('click',()=>{
    sideBar.classList.toggle('collapsed');
    viewer.classList.toggle('collapsed');
    toggleBtn.textContent=sideBar.classList.contains('collapsed')?"❯":"❮";
});

// === 訪客數: 使用 countapi.xyz ===
function updateVisitorCount(){
    fetch("https://api.countapi.xyz/hit/powwhuang_quarter/visits")
        .then(res => res.json())
        .then(data => {
            document.getElementById("visitorCount").textContent = data.value;
        })
        .catch(err => console.error("訪客計數錯誤:", err));
}

// 載入時更新訪客數
updateVisitorCount();

</script>
</body>
</html>
